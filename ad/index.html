<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SKEDULER AD</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== EXACT DOM VARIABLES ===== */
    :root {
      --bg: #0a0e13;
      --panel: #222a35;
      --muted: #9ca3af;
      --text: #f9fafb;
      --accent: #3b82f6;
      --row: #222a35;
      --rowAlt: #1a2129;
      --border: #374151;
      --ad-purple: #a371f7;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* ===== HEADER - AD STYLE ===== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      height: 48px;
      flex-shrink: 0;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ef4444;
    }
    
    .status-dot.connected {
      background: var(--ad-purple);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(163, 113, 247, 0.7); }
      50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(163, 113, 247, 0); }
    }
    
    .channel-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-logo {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text);
    }
    
    .ad-badge {
      background: var(--ad-purple);
      color: #fff;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
      letter-spacing: 1px;
    }
    
    /* Sharpie icon in header */
    .header-logo svg {
      width: 20px;
      height: 20px;
    }
    
    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #schedule-container {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .schedule-scroll {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    
    /* ===== TABLE STYLING - EXACT DOM CLONE ===== */
    table.schedule {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      background: var(--row);
      box-shadow: 0 0 0 2px var(--ad-purple), 0 0 20px rgba(163, 113, 247, 0.3);
      border-radius: 8px;
    }
    
    table.schedule th,
    table.schedule td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
      vertical-align: middle;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    table.schedule thead th {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #141920;
      font-weight: 600;
      color: var(--text);
    }
    
    table.schedule tbody tr {
      background: var(--row);
    }
    
    table.schedule tbody tr:nth-child(even) {
      background: var(--rowAlt);
    }
    
    /* ===== DRAG & ACTION COLUMNS - EXACT DOM STYLING ===== */
    table.schedule thead th[data-key="drag"],
    table.schedule thead th[data-key="actions"],
    table.schedule tbody td[data-key="drag"],
    table.schedule tbody td[data-key="actions"] {
      background: #141920;
      border: 1px solid #ffffff;
      overflow: hidden;
    }
    
    /* Drag column */
    table.schedule thead th[data-key="drag"],
    table.schedule tbody td[data-key="drag"] {
      width: 36px;
      min-width: 36px;
      max-width: 36px;
      text-align: center;
      vertical-align: middle;
      cursor: grab;
      user-select: none;
      padding: 0;
    }
    
    table.schedule tbody td[data-key="drag"]:active {
      cursor: grabbing;
    }
    
    /* 3x3 drag handle dots - exact DOM pattern */
    .drag-dots {
      display: inline-block;
      width: 12px;
      height: 12px;
      vertical-align: middle;
      background-image: 
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px),
        radial-gradient(circle, #999 1px, transparent 1px);
      background-size: 2px 2px;
      background-position: 
        0 0, 5px 0, 10px 0,
        0 5px, 5px 5px, 10px 5px,
        0 10px, 5px 10px, 10px 10px;
      background-repeat: no-repeat;
    }
    
    /* Action column */
    table.schedule thead th[data-key="actions"],
    table.schedule tbody td[data-key="actions"] {
      width: 36px;
      min-width: 36px;
      max-width: 36px;
      text-align: center;
      vertical-align: middle;
      padding: 0;
    }
    
    /* Action buttons container */
    td[data-key="actions"] > div,
    th[data-key="actions"] > div {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }
    
    /* Sharpie button - exact DOM styling */
    button.sharpie {
      margin: 0;
      padding: 0;
      width: 22px;
      height: 22px;
      min-width: 22px;
      min-height: 22px;
      max-width: 22px;
      max-height: 22px;
      box-sizing: border-box;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: white;
      color: var(--accent);
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    button.sharpie svg {
      width: 14px;
      height: 14px;
    }
    
    button.sharpie.active {
      background: #f44336;
      color: white;
      border-color: #d32f2f;
    }
    
    /* Master sharpie in header */
    button.master-sharpie-toggle {
      margin: 0;
      padding: 0;
      width: 22px;
      height: 22px;
      min-width: 22px;
      min-height: 22px;
      max-width: 22px;
      max-height: 22px;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f44336;
      color: white;
      border: 1px solid #d32f2f;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    button.master-sharpie-toggle svg {
      width: 14px;
      height: 14px;
    }
    
    button.master-sharpie-toggle.lines-hidden {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    /* ===== DRAGGING STATES - EXACT DOM ===== */
    tr.dragging {
      opacity: 0.6;
      outline: 2px dashed var(--accent);
    }
    
    tr.subchild.attached {
      outline: 2px solid #3a7bffcc;
    }
    
    /* ===== SHARPIE LINES ===== */
    .sharpie-line-element {
      position: absolute;
      height: 4px;
      background: #f44336;
      pointer-events: none;
      z-index: 500;
    }
    
    body.sharpie-lines-hidden .sharpie-line-element {
      display: none;
    }
    
    /* ===== DURATION EDITOR POPUP ===== */
    .duration-popup {
      position: fixed;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
    }
    
    .duration-popup.show {
      display: block;
    }
    
    .duration-popup input {
      width: 80px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      text-align: center;
    }
    
    .duration-popup input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* ===== RESIZE HANDLES ===== */
    .col-resize-grip {
      position: absolute;
      right: -4px;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: col-resize;
      z-index: 101;
    }
    
    .row-resize-grip {
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 100%;
      height: 8px;
      cursor: row-resize;
      z-index: 101;
    }
    
    /* ===== FOOTER ===== */
    .footer {
      text-align: center;
      padding: 8px;
      font-size: 11px;
      color: var(--muted);
      background: var(--panel);
      border-top: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <button class="status-btn" id="statusBtn" title="Connection status">
        <span class="status-dot" id="statusDot"></span>
      </button>
      <div class="channel-name" id="channelName">Loading...</div>
    </div>
    
    <div class="header-right">
      <div class="header-logo">
        <span>SKEDULER</span>
        <span class="ad-badge">AD</span>
        <svg viewBox="195 40 100 130">
          <defs>
            <linearGradient id="hCapG" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#cc2222"/>
              <stop offset="40%" stop-color="#ee3333"/>
              <stop offset="100%" stop-color="#aa1111"/>
            </linearGradient>
            <linearGradient id="hTipG" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#dd2222"/>
              <stop offset="100%" stop-color="#991111"/>
            </linearGradient>
            <linearGradient id="hBodyG" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#d0d0d0"/>
              <stop offset="30%" stop-color="#eeeeee"/>
              <stop offset="70%" stop-color="#e0e0e0"/>
              <stop offset="100%" stop-color="#c8c8c8"/>
            </linearGradient>
            <linearGradient id="hClipG" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#aa1111"/>
              <stop offset="50%" stop-color="#dd3333"/>
              <stop offset="100%" stop-color="#991111"/>
            </linearGradient>
          </defs>
          <g transform="rotate(45 245 96)">
            <path fill="url(#hCapG)" d="m230,66l0,-35q0,-15 12,-21q3,-2 6,0q12,6 12,21l0,35l-30,0z"/>
            <path fill="rgba(255,255,255,0.25)" d="m234,61l0,-27q0,-14 8,-20l0,47l-8,0z"/>
            <path fill="url(#hClipG)" d="m258,21l4,0q6,0 6,6l0,47q0,2 -2,2l-6,0q-2,0 -2,-2l0,-53z"/>
            <ellipse fill="#881111" cx="263" cy="76" rx="5" ry="2.5"/>
            <path fill="url(#hBodyG)" d="m231.5,66l0,75q0,15 6.5,25l14,0q6.5,-10 6.5,-25l0,-75l-27,0z"/>
            <rect fill="rgba(255,255,255,0.4)" x="234" y="69" width="5" height="68" rx="2"/>
            <path fill="url(#hTipG)" d="m238,166q-2,10 7,25q9,-15 7,-25l-14,0z"/>
            <path fill="rgba(255,255,255,0.15)" d="m240,168q-1,8 5,20l0,-19l-5,-1z"/>
          </g>
        </svg>
      </div>
    </div>
  </div>
  
  <div class="main-content">
    <div id="schedule-container">
      <div class="schedule-scroll" id="scheduleScroll">
        <!-- Schedule table injected here -->
      </div>
    </div>
  </div>
  
  <div class="footer" id="footer">
    Waiting for connection...
  </div>
  
  <!-- Duration Editor Popup -->
  <div class="duration-popup" id="durationPopup">
    <input type="text" id="durationInput" placeholder="0:30">
  </div>

<script>
(function() {
  'use strict';
  
  // === CONFIG ===
  const SUPABASE_URL = 'https://qcnepxcqilqrhayzhlfa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbmVweGNxaWxxcmhheXpobGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwMjYsImV4cCI6MjA3ODAzNDAyNn0.Gz7wvMgtu-UtCqw-5MF9s-T-pk-eo2TSw7zOtedWozk';
  
  // === STATE ===
  let supabase = null;
  let channel = null;
  let channelCode = null;
  let draggingRow = null;
  let markedRows = new Set();
  let linesHidden = false;
  
  // === INIT ===
  async function init() {
    // Get channel code from URL
    const params = new URLSearchParams(window.location.search);
    channelCode = params.get('c');
    
    if (!channelCode) {
      document.getElementById('channelName').textContent = 'No channel code';
      document.getElementById('footer').textContent = 'Add ?c=CODE to URL';
      return;
    }
    
    document.getElementById('channelName').textContent = 'Loading...';
    
    // Init Supabase
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Load initial schedule from bucket
    await loadScheduleFromBucket();
    
    // Subscribe to realtime
    subscribeToChannel();
  }
  
  // === LOAD SCHEDULE ===
  async function loadScheduleFromBucket() {
    try {
      // Look up broadcast by code (same as CHANNELS viewer)
      const { data: broadcast, error: lookupError } = await supabase
        .from('broadcasts')
        .select('*')
        .eq('code', channelCode.toUpperCase())
        .single();
      
      if (lookupError || !broadcast) {
        throw new Error('Broadcast not found');
      }
      
      // Set channel name
      const channelName = broadcast.title || `Channel ${channelCode}`;
      document.getElementById('channelName').textContent = channelName;
      
      // Build the HTML path (same logic as CHANNELS viewer)
      let htmlPath;
      if (broadcast.channel_number) {
        htmlPath = broadcast.user_id + '/ch' + broadcast.channel_number + '_' + broadcast.file_name + '.html';
      } else {
        htmlPath = broadcast.user_id + '/' + broadcast.file_name + '.html';
      }
      
      // Use public URL with cache-busting (same as CHANNELS viewer)
      const { data: urlData } = supabase.storage
        .from('schedule-files')
        .getPublicUrl(htmlPath);
      
      const cacheBuster = Date.now();
      const publicUrl = urlData.publicUrl + '?t=' + cacheBuster;
      
      console.log('[AD] Fetching:', publicUrl);
      
      const response = await fetch(publicUrl);
      if (!response.ok) {
        throw new Error('Could not load schedule');
      }
      
      const html = await response.text();
      injectSchedule(html);
      updateFooter('Loaded');
    } catch (err) {
      console.error('Load error:', err);
      document.getElementById('scheduleScroll').innerHTML = 
        `<div style="padding:40px;text-align:center;color:var(--muted);">
          No schedule found for channel ${channelCode}
        </div>`;
      updateFooter('No schedule');
    }
  }
  
  function injectSchedule(html) {
    const container = document.getElementById('scheduleScroll');
    container.innerHTML = html;
    
    // Add drag and action columns
    setupColumns();
    
    // Setup interactions
    setupRowInteractions();
    
    // Setup master sharpie in action header
    setupMasterSharpie();
  }
  
  // === SETUP COLUMNS ===
  function setupColumns() {
    const table = document.querySelector('#scheduleScroll table');
    if (!table) return;
    
    // Add drag column header
    const headerRow = table.querySelector('thead tr');
    if (headerRow && !headerRow.querySelector('th[data-key="drag"]')) {
      const th = document.createElement('th');
      th.setAttribute('data-key', 'drag');
      headerRow.insertBefore(th, headerRow.firstChild);
    }
    
    // Add action column header with master sharpie
    if (headerRow && !headerRow.querySelector('th[data-key="actions"]')) {
      const th = document.createElement('th');
      th.setAttribute('data-key', 'actions');
      th.innerHTML = `<div><button class="master-sharpie-toggle" id="masterSharpie" title="Toggle all sharpie lines">${getSharpieIconSVG()}</button></div>`;
      headerRow.appendChild(th);
    }
    
    // Add colgroup entries
    const colgroup = table.querySelector('colgroup');
    if (colgroup) {
      if (!colgroup.querySelector('col[data-key="drag"]')) {
        const col = document.createElement('col');
        col.setAttribute('data-key', 'drag');
        col.style.width = '36px';
        colgroup.insertBefore(col, colgroup.firstChild);
      }
      if (!colgroup.querySelector('col[data-key="actions"]')) {
        const col = document.createElement('col');
        col.setAttribute('data-key', 'actions');
        col.style.width = '36px';
        colgroup.appendChild(col);
      }
    }
    
    // Add cells to each row
    const rows = table.querySelectorAll('tbody tr[data-id]');
    rows.forEach(row => {
      // Drag cell
      if (!row.querySelector('td[data-key="drag"]')) {
        const td = document.createElement('td');
        td.setAttribute('data-key', 'drag');
        td.innerHTML = '<span class="drag-dots"></span>';
        row.insertBefore(td, row.firstChild);
      }
      
      // Action cell with sharpie button
      if (!row.querySelector('td[data-key="actions"]')) {
        const td = document.createElement('td');
        td.setAttribute('data-key', 'actions');
        td.innerHTML = `<div><button class="sharpie" title="Mark complete">${getSharpieIconSVG()}</button></div>`;
        row.appendChild(td);
      }
    });
  }
  
  function getSharpieIconSVG() {
    return `<svg viewBox="195 40 100 130">
      <defs>
        <linearGradient id="sCapG" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#cc2222"/>
          <stop offset="40%" stop-color="#ee3333"/>
          <stop offset="100%" stop-color="#aa1111"/>
        </linearGradient>
        <linearGradient id="sTipG" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#dd2222"/>
          <stop offset="100%" stop-color="#991111"/>
        </linearGradient>
        <linearGradient id="sBodyG" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#d0d0d0"/>
          <stop offset="30%" stop-color="#eeeeee"/>
          <stop offset="70%" stop-color="#e0e0e0"/>
          <stop offset="100%" stop-color="#c8c8c8"/>
        </linearGradient>
        <linearGradient id="sClipG" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#aa1111"/>
          <stop offset="50%" stop-color="#dd3333"/>
          <stop offset="100%" stop-color="#991111"/>
        </linearGradient>
      </defs>
      <g transform="rotate(45 245 96)">
        <path fill="url(#sCapG)" d="m230,66l0,-35q0,-15 12,-21q3,-2 6,0q12,6 12,21l0,35l-30,0z"/>
        <path fill="rgba(255,255,255,0.25)" d="m234,61l0,-27q0,-14 8,-20l0,47l-8,0z"/>
        <path fill="url(#sClipG)" d="m258,21l4,0q6,0 6,6l0,47q0,2 -2,2l-6,0q-2,0 -2,-2l0,-53z"/>
        <ellipse fill="#881111" cx="263" cy="76" rx="5" ry="2.5"/>
        <path fill="url(#sBodyG)" d="m231.5,66l0,75q0,15 6.5,25l14,0q6.5,-10 6.5,-25l0,-75l-27,0z"/>
        <rect fill="rgba(255,255,255,0.4)" x="234" y="69" width="5" height="68" rx="2"/>
        <path fill="url(#sTipG)" d="m238,166q-2,10 7,25q9,-15 7,-25l-14,0z"/>
        <path fill="rgba(255,255,255,0.15)" d="m240,168q-1,8 5,20l0,-19l-5,-1z"/>
      </g>
    </svg>`;
  }
  
  // === ROW INTERACTIONS ===
  function setupRowInteractions() {
    const tbody = document.querySelector('#scheduleScroll tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr[data-id]');
    
    rows.forEach(row => {
      // Make draggable
      row.draggable = true;
      
      // Drag start
      row.addEventListener('dragstart', (e) => {
        draggingRow = row;
        row.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', row.dataset.id);
      });
      
      // Drag end
      row.addEventListener('dragend', () => {
        if (draggingRow) {
          draggingRow.classList.remove('dragging');
        }
        draggingRow = null;
        
        // Broadcast new order
        broadcastRowOrder();
      });
      
      // Duration click
      const durCell = row.querySelector('td[data-key="duration"]');
      if (durCell) {
        durCell.style.cursor = 'pointer';
        durCell.addEventListener('click', () => openDurationEditor(row, durCell));
      }
      
      // Sharpie button click
      const sharpieBtn = row.querySelector('button.sharpie');
      if (sharpieBtn) {
        sharpieBtn.addEventListener('click', () => toggleRowSharpie(row));
      }
    });
    
    // Tbody dragover - exact DOM implementation
    tbody.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (!draggingRow) return;
      
      const candidates = Array.from(tbody.querySelectorAll('tr[data-id]:not(.dragging)'));
      const afterEl = calcAfter(candidates, e.clientY);
      
      if (afterEl === null) {
        tbody.appendChild(draggingRow);
      } else {
        tbody.insertBefore(draggingRow, afterEl);
      }
    });
  }
  
  // Exact DOM calcAfter function
  function calcAfter(list, y) {
    const scrollContainer = document.querySelector('.schedule-scroll');
    const zoom = scrollContainer ? parseFloat(scrollContainer.style.zoom || '1') : 1;
    const adjustedY = y / zoom;
    
    let closest = { offset: -Infinity, element: null };
    
    list.forEach(el => {
      const box = el.getBoundingClientRect();
      const offset = adjustedY - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        closest = { offset, element: el };
      }
    });
    
    return closest.element;
  }
  
  // === MASTER SHARPIE ===
  function setupMasterSharpie() {
    const btn = document.getElementById('masterSharpie');
    if (!btn) return;
    
    btn.addEventListener('click', () => {
      linesHidden = !linesHidden;
      document.body.classList.toggle('sharpie-lines-hidden', linesHidden);
      btn.classList.toggle('lines-hidden', linesHidden);
      broadcastEvent('sharpie-visibility', { hidden: linesHidden });
    });
  }
  
  // === SHARPIE TOGGLE ===
  function toggleRowSharpie(row) {
    const rowId = row.dataset.id;
    const btn = row.querySelector('button.sharpie');
    const scrollContainer = document.getElementById('scheduleScroll');
    
    if (markedRows.has(rowId)) {
      // Unmark
      markedRows.delete(rowId);
      btn?.classList.remove('active');
      
      // Remove line
      const line = scrollContainer.querySelector(`.sharpie-line-element[data-row-id="${rowId}"]`);
      if (line) line.remove();
      
      broadcastEvent('sharpie-toggle', { rowId, marked: false });
    } else {
      // Mark
      markedRows.add(rowId);
      btn?.classList.add('active');
      
      // Add line
      addSharpieLineElement(row);
      
      broadcastEvent('sharpie-toggle', { rowId, marked: true });
    }
  }
  
  function addSharpieLineElement(row) {
    const scrollContainer = document.getElementById('scheduleScroll');
    const table = scrollContainer.querySelector('table');
    if (!scrollContainer || !table) return;
    
    // Remove existing
    const existing = scrollContainer.querySelector(`.sharpie-line-element[data-row-id="${row.dataset.id}"]`);
    if (existing) existing.remove();
    
    // Create line
    const line = document.createElement('div');
    line.className = 'sharpie-line-element';
    line.dataset.rowId = row.dataset.id;
    
    // Position (skip drag column, end before action column)
    const padding = 42; // 36px column + 6px padding
    line.style.top = (row.offsetTop + row.offsetHeight / 2 - 2) + 'px';
    line.style.left = padding + 'px';
    line.style.right = padding + 'px';
    
    scrollContainer.appendChild(line);
  }
  
  function updateAllSharpieLines() {
    const scrollContainer = document.getElementById('scheduleScroll');
    markedRows.forEach(rowId => {
      const row = document.querySelector(`tr[data-id="${rowId}"]`);
      if (row) {
        const line = scrollContainer.querySelector(`.sharpie-line-element[data-row-id="${rowId}"]`);
        if (line) {
          line.style.top = (row.offsetTop + row.offsetHeight / 2 - 2) + 'px';
        }
      }
    });
  }
  
  // === DURATION EDITOR ===
  function openDurationEditor(row, cell) {
    const popup = document.getElementById('durationPopup');
    const input = document.getElementById('durationInput');
    
    const rect = cell.getBoundingClientRect();
    popup.style.left = rect.left + 'px';
    popup.style.top = (rect.bottom + 4) + 'px';
    popup.classList.add('show');
    
    input.value = cell.textContent.trim();
    input.focus();
    input.select();
    
    const close = () => {
      popup.classList.remove('show');
      document.removeEventListener('click', outsideClick);
      input.removeEventListener('keydown', keyHandler);
    };
    
    const save = () => {
      const newValue = input.value.trim();
      if (newValue !== cell.textContent.trim()) {
        cell.textContent = newValue;
        broadcastEvent('duration-change', { rowId: row.dataset.id, duration: newValue });
      }
      close();
    };
    
    const outsideClick = (e) => {
      if (!popup.contains(e.target) && e.target !== cell) {
        save();
      }
    };
    
    const keyHandler = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        save();
      } else if (e.key === 'Escape') {
        close();
      }
    };
    
    setTimeout(() => {
      document.addEventListener('click', outsideClick);
      input.addEventListener('keydown', keyHandler);
    }, 10);
  }
  
  // === REALTIME SYNC ===
  function subscribeToChannel() {
    channel = supabase.channel(`ad-sync-${channelCode}`, {
      config: { broadcast: { self: false } }
    });
    
    channel
      .on('broadcast', { event: 'row-reorder' }, handleIncomingReorder)
      .on('broadcast', { event: 'duration-change' }, handleIncomingDuration)
      .on('broadcast', { event: 'sharpie-toggle' }, handleIncomingSharpie)
      .on('broadcast', { event: 'sharpie-visibility' }, handleIncomingVisibility)
      .on('broadcast', { event: 'column-resize' }, handleIncomingColumnResize)
      .on('broadcast', { event: 'row-resize' }, handleIncomingRowResize)
      .on('broadcast', { event: 'full-sync' }, handleFullSync)
      .subscribe((status) => {
        const dot = document.getElementById('statusDot');
        if (status === 'SUBSCRIBED') {
          dot.classList.add('connected');
          updateFooter('Connected');
          
          // Request full sync from DOM
          broadcastEvent('request-sync', {});
        } else {
          dot.classList.remove('connected');
          updateFooter('Disconnected');
        }
      });
  }
  
  function broadcastEvent(event, payload) {
    if (channel) {
      channel.send({ type: 'broadcast', event, payload: { ...payload, source: 'ad' } });
    }
  }
  
  function broadcastRowOrder() {
    const tbody = document.querySelector('#scheduleScroll tbody');
    if (!tbody) return;
    
    const order = Array.from(tbody.querySelectorAll('tr[data-id]'))
      .map(row => row.dataset.id);
    
    broadcastEvent('row-reorder', { order, source: 'ad' });
  }
  
  // === INCOMING EVENT HANDLERS ===
  function handleIncomingReorder({ payload }) {
    if (!payload?.order) return;
    
    const tbody = document.querySelector('#scheduleScroll tbody');
    if (!tbody) return;
    
    payload.order.forEach(id => {
      const row = tbody.querySelector(`tr[data-id="${id}"]`);
      if (row) tbody.appendChild(row);
    });
    
    updateAllSharpieLines();
  }
  
  function handleIncomingDuration({ payload }) {
    if (!payload?.rowId) return;
    
    const row = document.querySelector(`tr[data-id="${payload.rowId}"]`);
    if (!row) return;
    
    const cell = row.querySelector('td[data-key="duration"]');
    if (cell) cell.textContent = payload.duration;
  }
  
  function handleIncomingSharpie({ payload }) {
    if (!payload?.rowId) return;
    
    const row = document.querySelector(`tr[data-id="${payload.rowId}"]`);
    if (!row) return;
    
    const btn = row.querySelector('button.sharpie');
    
    if (payload.marked) {
      markedRows.add(payload.rowId);
      btn?.classList.add('active');
      addSharpieLineElement(row);
    } else {
      markedRows.delete(payload.rowId);
      btn?.classList.remove('active');
      const line = document.getElementById('scheduleScroll')
        .querySelector(`.sharpie-line-element[data-row-id="${payload.rowId}"]`);
      if (line) line.remove();
    }
  }
  
  function handleIncomingVisibility({ payload }) {
    linesHidden = payload.hidden;
    document.body.classList.toggle('sharpie-lines-hidden', linesHidden);
    
    const btn = document.getElementById('masterSharpie');
    if (btn) btn.classList.toggle('lines-hidden', linesHidden);
  }
  
  function handleIncomingColumnResize({ payload }) {
    if (!payload?.key || !payload?.width) return;
    
    const col = document.querySelector(`col[data-key="${payload.key}"]`);
    if (col) col.style.width = payload.width + 'px';
    
    const th = document.querySelector(`th[data-key="${payload.key}"]`);
    if (th) th.style.width = payload.width + 'px';
  }
  
  function handleIncomingRowResize({ payload }) {
    if (!payload?.rowId || !payload?.height) return;
    
    const row = document.querySelector(`tr[data-id="${payload.rowId}"]`);
    if (row) {
      row.style.height = payload.height + 'px';
      updateAllSharpieLines();
    }
  }
  
  function handleFullSync({ payload }) {
    if (!payload) return;
    
    // Reload schedule if provided
    if (payload.html) {
      injectSchedule(payload.html);
    }
    
    // Apply row order
    if (payload.order) {
      handleIncomingReorder({ payload });
    }
    
    // Apply sharpie marks
    if (payload.sharpieRows) {
      payload.sharpieRows.forEach(rowId => {
        handleIncomingSharpie({ payload: { rowId, marked: true } });
      });
    }
    
    // Apply visibility
    if (payload.linesHidden !== undefined) {
      handleIncomingVisibility({ payload: { hidden: payload.linesHidden } });
    }
  }
  
  // === UTILITIES ===
  function updateFooter(status) {
    const footer = document.getElementById('footer');
    footer.textContent = `${status} â€¢ ${new Date().toLocaleTimeString()}`;
  }
  
  // === START ===
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
