<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SKEDULER AD</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0a0e13;
      --panel: #161b22;
      --muted: #9ca3af;
      --text: #f9fafb;
      --accent: #3b82f6;
      --row: #0d1117;
      --rowAlt: #1a2129;
      --border: #374151;
      --ad-purple: #a371f7;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* ===== HEADER ===== */
    .header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 12px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      min-height: 48px;
      flex-shrink: 0;
    }
    
    .header-left { display: flex; align-items: center; gap: 8px; justify-self: start; }
    .channel-label { font-size: 14px; color: var(--text); }
    .channel-label span { color: var(--muted); }
    .header-center { justify-self: center; display: flex; align-items: center; gap: 6px; }
    .header-right { display: flex; align-items: center; gap: 12px; justify-self: end; }
    
    .live-badge { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; height: 28px; }
    .live-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--muted); }
    .live-badge.live .live-dot { background: var(--ad-purple); animation: pulse 1.5s ease-in-out infinite; }
    .live-badge.live .live-text { color: var(--ad-purple); text-transform: uppercase; }
    .live-badge.manual .live-dot { background: var(--muted); }
    .live-badge.manual .live-text { display: none; }
    
    .header-progress-btn {
      width: 28px; height: 28px; padding: 4px; border-radius: 4px; border: none;
      background: var(--ad-purple); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .header-progress-btn:hover { filter: brightness(1.1); }
    .header-progress-btn.lines-hidden { background: var(--ad-purple); }
    .header-progress-btn:not(.lines-hidden) { background: #f44336; }
    
    @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.9); } }
    
    .header-logo { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; letter-spacing: 2px; color: var(--text); }
    .ad-badge { background: var(--ad-purple); color: #fff; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 3px; letter-spacing: 1px; }
    .header-logo svg { width: 20px; height: 20px; }
    
    /* ===== MAIN CONTENT ===== */
    .main-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    #schedule-container { flex: 1; overflow: hidden; position: relative; }
    .schedule-scroll { position: relative; width: 100%; height: 100%; overflow: auto; padding: 16px; }
    
    /* ===== TABLE - Purple border glow ===== */
    #scheduleScroll table,
    table.schedule {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      box-shadow: 0 0 0 2px var(--ad-purple), 0 0 20px rgba(163, 113, 247, 0.3);
      border-radius: 8px;
    }
    
    #scheduleScroll table th,
    #scheduleScroll table td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
      vertical-align: middle;
      font-size: 12px;
    }
    
    #scheduleScroll table thead th {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #161b22;
      font-weight: 600;
      color: var(--text);
    }
    
    /* ===== DRAG & ACTION COLUMNS ===== */
    td[data-key="drag"],
    td[data-key="actions"] {
      position: relative;
      padding: 0 !important;
      width: 36px;
      min-width: 36px;
      max-width: 36px;
    }
    
    th[data-key="drag"],
    th[data-key="actions"] {
      width: 36px;
      min-width: 36px;
      max-width: 36px;
      background: #161b22;
    }
    
    /* Absolute div covers row background */
    .cell-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #222a35;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    td[data-key="drag"] { cursor: grab; }
    td[data-key="drag"]:active { cursor: grabbing; }
    
    .drag-dots {
      display: inline-block;
      width: 12px; height: 12px;
      background-image: 
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px),
        radial-gradient(circle, #888 1px, transparent 1px);
      background-size: 2px 2px;
      background-position: 0 0, 5px 0, 10px 0, 0 5px, 5px 5px, 10px 5px, 0 10px, 5px 10px, 10px 10px;
      background-repeat: no-repeat;
    }
    
    button.sharpie {
      margin: 0; padding: 0;
      width: 22px; height: 22px;
      min-width: 22px; min-height: 22px;
      display: inline-flex; align-items: center; justify-content: center;
      background: white; color: var(--accent);
      border: 1px solid #e0e0e0; border-radius: 4px;
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button.sharpie svg { width: 14px; height: 14px; }
    button.sharpie.active { background: #f44336; color: white; border-color: #d32f2f; }
    
    /* ===== DRAGGING ===== */
    tr.dragging { opacity: 0.6; outline: 2px dashed var(--accent); }
    
    /* ===== SHARPIE LINES ===== */
    .sharpie-line-element {
      position: absolute;
      height: 4px;
      background: #f44336;
      pointer-events: none;
      z-index: 500;
    }
    body.sharpie-lines-hidden .sharpie-line-element { display: none; }
    
    /* ===== DURATION POPUP ===== */
    .duration-popup {
      position: fixed;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
    }
    .duration-popup.show { display: block; }
    .duration-popup input {
      width: 80px; padding: 6px 8px;
      border: 1px solid var(--border); border-radius: 4px;
      background: var(--bg); color: var(--text);
      font-size: 14px; text-align: center;
    }
    
    /* ===== FOOTER ===== */
    .footer {
      text-align: center; padding: 8px;
      font-size: 11px; color: var(--muted);
      background: var(--panel);
      border-top: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <div class="channel-label">
        <span>Channel:</span> <strong id="channelName">Loading...</strong>
      </div>
    </div>
    <div class="header-center">
      <div class="header-logo">
        <span>SKEDULER</span>
        <span class="ad-badge">AD</span>
        <svg viewBox="195 40 100 130"><g transform="rotate(45 245 96)"><path fill="#dd2222" d="m230,66l0,-35q0,-15 12,-21q3,-2 6,0q12,6 12,21l0,35l-30,0z"/><path fill="#e0e0e0" d="m231.5,66l0,75q0,15 6.5,25l14,0q6.5,-10 6.5,-25l0,-75l-27,0z"/><path fill="#bb1111" d="m238,166q-2,10 7,25q9,-15 7,-25l-14,0z"/></g></svg>
      </div>
    </div>
    <div class="header-right">
      <div class="live-badge manual" id="liveBadge">
        <span class="live-text" id="liveText">LIVE</span>
        <span class="live-dot"></span>
      </div>
      <button class="header-progress-btn" id="progressBtn" title="Toggle Progress" onclick="document.body.classList.toggle('sharpie-lines-hidden');this.classList.toggle('lines-hidden');">
        <svg width="18" height="18" viewBox="195 40 100 130"><g transform="rotate(45 245 96)"><path fill="#dd2222" d="m230,66l0,-35q0,-15 12,-21q3,-2 6,0q12,6 12,21l0,35l-30,0z"/><path fill="#e0e0e0" d="m231.5,66l0,75q0,15 6.5,25l14,0q6.5,-10 6.5,-25l0,-75l-27,0z"/><path fill="#bb1111" d="m238,166q-2,10 7,25q9,-15 7,-25l-14,0z"/></g></svg>
      </button>
    </div>
  </div>
  
  <div class="main-content">
    <div id="schedule-container">
      <div class="schedule-scroll" id="scheduleScroll"></div>
    </div>
  </div>
  
  <div class="footer" id="footer">Waiting for connection...</div>
  
  <div class="duration-popup" id="durationPopup">
    <input type="text" id="durationInput" placeholder="0:30">
  </div>

<script>
(function() {
  'use strict';
  
  const SUPABASE_URL = 'https://qcnepxcqilqrhayzhlfa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbmVweGNxaWxxcmhheXpobGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTgwMjYsImV4cCI6MjA3ODAzNDAyNn0.Gz7wvMgtu-UtCqw-5MF9s-T-pk-eo2TSw7zOtedWozk';
  
  let supabase = null;
  let channel = null;
  let channelCode = null;
  let draggingRow = null;
  let markedRows = new Set();
  let linesHidden = false;
  let isLiveMode = false;
  
  async function init() {
    const params = new URLSearchParams(window.location.search);
    channelCode = params.get('c');
    
    if (!channelCode) {
      document.getElementById('channelName').textContent = 'No channel code';
      document.getElementById('footer').textContent = 'Add ?c=CODE to URL';
      return;
    }
    
    document.getElementById('channelName').textContent = 'Loading...';
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    await loadScheduleFromBucket();
    subscribeToChannel();
  }
  
  async function loadScheduleFromBucket() {
    try {
      const { data: broadcast, error: lookupError } = await supabase
        .from('broadcasts')
        .select('*')
        .eq('code', channelCode.toUpperCase())
        .single();
      
      if (lookupError || !broadcast) throw new Error('Broadcast not found');
      
      isLiveMode = broadcast.auto_update === true;
      updateLiveStatus();
      
      document.getElementById('channelName').textContent = broadcast.title || `Channel ${channelCode}`;
      
      let htmlPath = broadcast.channel_number 
        ? `${broadcast.user_id}/ch${broadcast.channel_number}_${broadcast.file_name}.html`
        : `${broadcast.user_id}/${broadcast.file_name}.html`;
      
      const { data: urlData } = supabase.storage.from('schedule-files').getPublicUrl(htmlPath);
      const publicUrl = urlData.publicUrl + '?t=' + Date.now();
      
      const response = await fetch(publicUrl);
      if (!response.ok) throw new Error('Could not load schedule');
      
      const html = await response.text();
      injectSchedule(html);
      updateFooter('Loaded');
    } catch (err) {
      console.error('Load error:', err);
      document.getElementById('scheduleScroll').innerHTML = 
        `<div style="padding:40px;text-align:center;color:var(--muted);">No schedule found for channel ${channelCode}</div>`;
      updateFooter('No schedule');
    }
  }
  
  function injectSchedule(html) {
    const container = document.getElementById('scheduleScroll');
    container.innerHTML = html;
    
    // Remove buttons and style tags from loaded HTML
    container.querySelectorAll('button').forEach(btn => btn.remove());
    container.querySelectorAll('style').forEach(s => s.remove());
    container.querySelectorAll('.completed-line').forEach(el => el.remove());
    
    // DO NOT strip row backgrounds - we need them for colors!
    
    setupColumns();
    setupRowInteractions();
    initCompletedState();
  }
  
  function initCompletedState() {
    document.querySelectorAll('#scheduleScroll tr[data-completed="true"], #scheduleScroll tr.row-complete').forEach(row => {
      const rowId = row.dataset.id;
      if (rowId && !markedRows.has(rowId)) {
        markedRows.add(rowId);
        const btn = row.querySelector('button.sharpie');
        if (btn) btn.classList.add('active');
        addSharpieLineElement(row);
      }
    });
  }
  
  function setupColumns() {
    const table = document.querySelector('#scheduleScroll table');
    if (!table) return;
    
    const headerRow = table.querySelector('thead tr');
    
    // Add drag header
    if (headerRow && !headerRow.querySelector('th[data-key="drag"]')) {
      const th = document.createElement('th');
      th.setAttribute('data-key', 'drag');
      headerRow.insertBefore(th, headerRow.firstChild);
    }
    
    // Add action header
    if (headerRow && !headerRow.querySelector('th[data-key="actions"]')) {
      const th = document.createElement('th');
      th.setAttribute('data-key', 'actions');
      headerRow.appendChild(th);
    }
    
    // Add colgroup entries
    const colgroup = table.querySelector('colgroup');
    if (colgroup) {
      if (!colgroup.querySelector('col[data-key="drag"]')) {
        const col = document.createElement('col');
        col.setAttribute('data-key', 'drag');
        col.style.width = '36px';
        colgroup.insertBefore(col, colgroup.firstChild);
      }
      if (!colgroup.querySelector('col[data-key="actions"]')) {
        const col = document.createElement('col');
        col.setAttribute('data-key', 'actions');
        col.style.width = '36px';
        colgroup.appendChild(col);
      }
    }
    
    // Add cells to each row
    table.querySelectorAll('tbody tr[data-id]').forEach(row => {
      // Drag cell
      if (!row.querySelector('td[data-key="drag"]')) {
        const td = document.createElement('td');
        td.setAttribute('data-key', 'drag');
        td.innerHTML = '<div class="cell-bg"><span class="drag-dots"></span></div>';
        row.insertBefore(td, row.firstChild);
      }
      
      // Action cell
      if (!row.querySelector('td[data-key="actions"]')) {
        const td = document.createElement('td');
        td.setAttribute('data-key', 'actions');
        td.innerHTML = `<div class="cell-bg"><button class="sharpie" title="Mark complete">${getSharpieIconSVG()}</button></div>`;
        row.appendChild(td);
      }
    });
  }
  
  function getSharpieIconSVG() {
    return `<svg viewBox="195 40 100 130"><g transform="rotate(45 245 96)"><path fill="#dd2222" d="m230,66l0,-35q0,-15 12,-21q3,-2 6,0q12,6 12,21l0,35l-30,0z"/><path fill="#e0e0e0" d="m231.5,66l0,75q0,15 6.5,25l14,0q6.5,-10 6.5,-25l0,-75l-27,0z"/><path fill="#bb1111" d="m238,166q-2,10 7,25q9,-15 7,-25l-14,0z"/></g></svg>`;
  }
  
  function setupRowInteractions() {
    const tbody = document.querySelector('#scheduleScroll tbody');
    if (!tbody) return;
    
    tbody.querySelectorAll('tr[data-id]').forEach(row => {
      row.draggable = true;
      
      row.addEventListener('dragstart', (e) => {
        draggingRow = row;
        row.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', row.dataset.id);
      });
      
      row.addEventListener('dragend', () => {
        if (draggingRow) draggingRow.classList.remove('dragging');
        draggingRow = null;
        broadcastRowOrder();
      });
      
      const durCell = row.querySelector('td[data-key="duration"]');
      if (durCell) {
        durCell.style.cursor = 'pointer';
        durCell.addEventListener('click', () => openDurationEditor(row, durCell));
      }
      
      const sharpieBtn = row.querySelector('button.sharpie');
      if (sharpieBtn) {
        sharpieBtn.addEventListener('click', () => toggleRowSharpie(row));
      }
    });
    
    tbody.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (!draggingRow) return;
      
      const candidates = Array.from(tbody.querySelectorAll('tr[data-id]:not(.dragging)'));
      let closest = { offset: -Infinity, element: null };
      
      candidates.forEach(el => {
        const box = el.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: el };
        }
      });
      
      if (closest.element === null) {
        tbody.appendChild(draggingRow);
      } else {
        tbody.insertBefore(draggingRow, closest.element);
      }
    });
  }
  
  function toggleRowSharpie(row) {
    const rowId = row.dataset.id;
    const btn = row.querySelector('button.sharpie');
    const container = document.getElementById('scheduleScroll');
    
    if (markedRows.has(rowId)) {
      markedRows.delete(rowId);
      btn?.classList.remove('active');
      container.querySelector(`.sharpie-line-element[data-row-id="${rowId}"]`)?.remove();
      broadcastEvent('sharpie-toggle', { rowId, marked: false, source: 'ad' });
    } else {
      markedRows.add(rowId);
      btn?.classList.add('active');
      addSharpieLineElement(row);
      broadcastEvent('sharpie-toggle', { rowId, marked: true, source: 'ad' });
    }
  }
  
  function addSharpieLineElement(row) {
    const container = document.getElementById('scheduleScroll');
    const table = container.querySelector('table');
    if (!container || !table) return;
    
    container.querySelector(`.sharpie-line-element[data-row-id="${row.dataset.id}"]`)?.remove();
    
    const line = document.createElement('div');
    line.className = 'sharpie-line-element';
    line.dataset.rowId = row.dataset.id;
    line.style.top = (table.offsetTop + row.offsetTop + row.offsetHeight / 2 - 2) + 'px';
    line.style.left = (table.offsetLeft + 36) + 'px';
    line.style.width = (table.offsetWidth - 72) + 'px';
    container.appendChild(line);
  }
  
  function updateAllSharpieLines() {
    const container = document.getElementById('scheduleScroll');
    const table = container?.querySelector('table');
    if (!table) return;
    
    markedRows.forEach(rowId => {
      const row = document.querySelector(`tr[data-id="${rowId}"]`);
      const line = container.querySelector(`.sharpie-line-element[data-row-id="${rowId}"]`);
      if (row && line) {
        line.style.top = (table.offsetTop + row.offsetTop + row.offsetHeight / 2 - 2) + 'px';
        line.style.left = (table.offsetLeft + 36) + 'px';
        line.style.width = (table.offsetWidth - 72) + 'px';
      }
    });
  }
  
  function openDurationEditor(row, cell) {
    const popup = document.getElementById('durationPopup');
    const input = document.getElementById('durationInput');
    const rect = cell.getBoundingClientRect();
    
    popup.style.left = rect.left + 'px';
    popup.style.top = (rect.bottom + 4) + 'px';
    popup.classList.add('show');
    input.value = cell.textContent.trim();
    input.focus();
    input.select();
    
    const close = () => {
      popup.classList.remove('show');
      document.removeEventListener('click', outsideClick);
      input.removeEventListener('keydown', keyHandler);
    };
    
    const save = () => {
      const newValue = input.value.trim();
      if (newValue !== cell.textContent.trim()) {
        cell.textContent = newValue;
        broadcastEvent('duration-change', { rowId: row.dataset.id, duration: newValue, source: 'ad' });
      }
      close();
    };
    
    const outsideClick = (e) => { if (!popup.contains(e.target) && e.target !== cell) save(); };
    const keyHandler = (e) => {
      if (e.key === 'Enter') { e.preventDefault(); save(); }
      else if (e.key === 'Escape') close();
    };
    
    setTimeout(() => {
      document.addEventListener('click', outsideClick);
      input.addEventListener('keydown', keyHandler);
    }, 10);
  }
  
  function subscribeToChannel() {
    channel = supabase.channel(`ad-sync-${channelCode.toUpperCase()}`, {
      config: { broadcast: { self: false } }
    });
    
    channel
      .on('broadcast', { event: 'row-reorder' }, ({ payload }) => {
        if (!payload?.order) return;
        const tbody = document.querySelector('#scheduleScroll tbody');
        if (!tbody) return;
        payload.order.forEach(id => {
          const row = tbody.querySelector(`tr[data-id="${id}"]`);
          if (row) tbody.appendChild(row);
        });
        updateAllSharpieLines();
      })
      .on('broadcast', { event: 'duration-change' }, ({ payload }) => {
        if (!payload?.rowId) return;
        const row = document.querySelector(`tr[data-id="${payload.rowId}"]`);
        const cell = row?.querySelector('td[data-key="duration"]');
        if (cell) cell.textContent = payload.duration;
      })
      .on('broadcast', { event: 'sharpie-toggle' }, ({ payload }) => {
        if (!payload?.rowId) return;
        const row = document.querySelector(`tr[data-id="${payload.rowId}"]`);
        if (!row) return;
        const btn = row.querySelector('button.sharpie');
        if (payload.marked) {
          markedRows.add(payload.rowId);
          btn?.classList.add('active');
          addSharpieLineElement(row);
        } else {
          markedRows.delete(payload.rowId);
          btn?.classList.remove('active');
          document.getElementById('scheduleScroll').querySelector(`.sharpie-line-element[data-row-id="${payload.rowId}"]`)?.remove();
        }
      })
      .on('broadcast', { event: 'sharpie-visibility' }, ({ payload }) => {
        linesHidden = payload.hidden;
        document.body.classList.toggle('sharpie-lines-hidden', linesHidden);
      })
      .on('broadcast', { event: 'full-sync' }, ({ payload }) => {
        if (payload?.html) injectSchedule(payload.html);
        if (payload?.order) {
          const tbody = document.querySelector('#scheduleScroll tbody');
          payload.order.forEach(id => {
            const row = tbody?.querySelector(`tr[data-id="${id}"]`);
            if (row) tbody.appendChild(row);
          });
        }
        updateAllSharpieLines();
      })
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          updateFooter('Connected');
          broadcastEvent('request-sync', {});
        } else {
          updateFooter('Disconnected');
        }
      });
  }
  
  function broadcastEvent(event, payload) {
    if (channel) channel.send({ type: 'broadcast', event, payload: { ...payload, source: 'ad' } });
  }
  
  function broadcastRowOrder() {
    const tbody = document.querySelector('#scheduleScroll tbody');
    if (!tbody) return;
    const order = Array.from(tbody.querySelectorAll('tr[data-id]')).map(r => r.dataset.id);
    broadcastEvent('row-reorder', { order, source: 'ad' });
  }
  
  function updateFooter(status) {
    document.getElementById('footer').textContent = `${status} â€¢ ${new Date().toLocaleTimeString()}`;
  }
  
  function updateLiveStatus() {
    const badge = document.getElementById('liveBadge');
    badge.classList.remove('live', 'manual');
    badge.classList.add(isLiveMode ? 'live' : 'manual');
  }
  
  setInterval(async () => {
    if (!channelCode) return;
    try {
      const { data } = await supabase.from('broadcasts').select('auto_update').eq('code', channelCode.toUpperCase()).single();
      if (data) {
        const wasLive = isLiveMode;
        isLiveMode = data.auto_update === true;
        if (wasLive !== isLiveMode) updateLiveStatus();
      }
    } catch (e) {}
  }, 30000);

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
